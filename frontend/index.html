<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFridge - Your Personal Recipe Assistant</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Karla:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Karla', sans-serif;
            background: linear-gradient(135deg, #FDF8F3 0%, #F5EDE4 100%);
            color: #2C2416;
            min-height: 100vh;
        }

        #root {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
            color: #D97642;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .tagline {
            text-align: center;
            font-size: 1.1rem;
            color: #8FA68E;
            margin-bottom: 2rem;
        }

        /* Authentication Styles */
        .auth-container {
            max-width: 400px;
            margin: 4rem auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: #F5EDE4;
            color: #2C2416;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: #D97642;
            color: white;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2C2416;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #E5D5C5;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #D97642;
        }

        .btn {
            width: 100%;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #D97642;
            color: white;
        }

        .btn-primary:hover {
            background: #C15D2F;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #8FA68E;
            color: white;
        }

        .btn-secondary:hover {
            background: #7A8F7B;
        }

        .error-message {
            background: #FFE5E5;
            color: #C41E3A;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .success-message {
            background: #E8F5E9;
            color: #2E7D32;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        /* Header with User Info */
        .app-header {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #D97642, #8FA68E);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        /* Profile Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .profile-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #E5D5C5;
        }

        .profile-section:last-child {
            border-bottom: none;
        }

        /* Rest of original styles... */
        .section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .ingredient-input-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .ingredient-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #E5D5C5;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .ingredient-input:focus {
            outline: none;
            border-color: #D97642;
        }

        .add-btn {
            padding: 0.75rem 1.5rem;
            background: #D97642;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .add-btn:hover {
            background: #C15D2F;
            transform: translateY(-2px);
        }

        .ingredients-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .ingredient-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #8FA68E, #7A8F7B);
            color: white;
            border-radius: 20px;
            font-size: 0.9rem;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .remove-ingredient {
            margin-left: 0.5rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2C2416;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #E5D5C5;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .recipe-card {
            background: #FDF8F3;
            border: 2px solid #E5D5C5;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .recipe-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(217, 118, 66, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.6s;
        }

        .recipe-card:hover::before {
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .recipe-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
            border-color: #D97642;
        }

        .recipe-header {
            position: relative;
            z-index: 1;
        }

        .recipe-name {
            font-size: 1.5rem;
            color: #D97642;
            margin-bottom: 0.5rem;
        }

        .match-percentage {
            font-size: 2rem;
            font-weight: bold;
            color: #8FA68E;
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #E5D5C5;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8FA68E, #D97642);
            transition: width 0.5s ease;
        }

        .recipe-details {
            font-size: 0.9rem;
            color: #666;
            margin: 0.5rem 0;
        }

        .recipe-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-cook {
            flex: 1;
            padding: 0.75rem;
            background: #D97642;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-cook:hover {
            background: #C15D2F;
        }

        .btn-favorite {
            padding: 0.75rem;
            background: #8FA68E;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-favorite:hover {
            background: #7A8F7B;
        }

        .btn-favorite.favorited {
            background: #FFD700;
        }

        /* Cooking Mode */
        .cooking-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 2rem;
        }

        .cooking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .exit-cooking {
            padding: 0.75rem 1.5rem;
            background: #E5D5C5;
            color: #2C2416;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .step-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .step-number {
            font-size: 1.5rem;
            color: #8FA68E;
            margin-bottom: 1rem;
        }

        .step-instruction {
            font-size: 2rem;
            line-height: 1.6;
            margin-bottom: 2rem;
            font-family: 'Playfair Display', serif;
        }

        .step-timer {
            font-size: 1.5rem;
            color: #D97642;
            margin-bottom: 2rem;
        }

        .step-navigation {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .nav-btn {
            flex: 1;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn-prev {
            background: #E5D5C5;
            color: #2C2416;
        }

        .nav-btn-next {
            background: #D97642;
            color: white;
        }

        .completion-screen {
            text-align: center;
        }

        .completion-emoji {
            font-size: 5rem;
            margin-bottom: 2rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .empty-state-emoji {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Cooking Terms Glossary */
        .cooking-term {
            color: #D97642;
            text-decoration: underline;
            text-decoration-style: dotted;
            cursor: help;
            font-weight: 600;
            transition: all 0.2s;
        }

        .cooking-term:hover {
            background: #FFF5E6;
            text-decoration-style: solid;
        }

        .term-popup {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            max-width: 500px;
            width: 90%;
            background: white;
            border: 3px solid #D97642;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .term-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #E5D5C5;
        }

        .term-popup-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #D97642;
            font-family: 'Playfair Display', serif;
            text-transform: capitalize;
        }

        .term-popup-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .term-popup-close:hover {
            background: #F5EDE4;
            color: #2C2416;
        }

        .term-popup-definition {
            font-size: 1rem;
            line-height: 1.6;
            color: #2C2416;
        }

        .term-popup-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Checkbox styles */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #F5EDE4;
            border: 2px solid #E5D5C5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-label:hover {
            border-color: #D97642;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .checkbox-label input[type="checkbox"]:checked + span {
            font-weight: 600;
            color: #D97642;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Cooking Term Popup Component
        function CookingTermPopup({ term, definition, onClose }) {
            useEffect(() => {
                const handleEscape = (e) => {
                    if (e.key === 'Escape') onClose();
                };
                document.addEventListener('keydown', handleEscape);
                return () => document.removeEventListener('keydown', handleEscape);
            }, [onClose]);

            return (
                <div className="term-popup">
                    <div className="term-popup-header">
                        <div>
                            <div className="term-popup-icon">üìñ</div>
                            <div className="term-popup-title">{term}</div>
                        </div>
                        <button className="term-popup-close" onClick={onClose}>√ó</button>
                    </div>
                    <div className="term-popup-definition">
                        {definition}
                    </div>
                </div>
            );
        }

        // Function to highlight cooking terms in text
        function highlightCookingTerms(text, cookingTerms, onTermClick) {
            if (!text || !cookingTerms || Object.keys(cookingTerms).length === 0) {
                return <span>{text}</span>;
            }

            // Create a regex pattern to match any cooking term (case-insensitive)
            const termPattern = Object.keys(cookingTerms)
                .sort((a, b) => b.length - a.length) // Longer terms first to avoid partial matches
                .map(term => term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')) // Escape regex special chars
                .join('|');
            
            const regex = new RegExp(`\\b(${termPattern})\\b`, 'gi');
            
            const parts = [];
            let lastIndex = 0;
            let match;
            let key = 0;

            while ((match = regex.exec(text)) !== null) {
                // Add text before the match
                if (match.index > lastIndex) {
                    parts.push(<span key={`text-${key++}`}>{text.substring(lastIndex, match.index)}</span>);
                }
                
                // Add the highlighted term
                const matchedTerm = match[0];
                const termKey = matchedTerm.toLowerCase();
                
                parts.push(
                    <span
                        key={`term-${key++}`}
                        className="cooking-term"
                        onClick={(e) => {
                            e.stopPropagation();
                            onTermClick(matchedTerm, cookingTerms[termKey]);
                        }}
                        title="Click to see definition"
                    >
                        {matchedTerm}
                    </span>
                );
                
                lastIndex = regex.lastIndex;
            }
            
            // Add remaining text
            if (lastIndex < text.length) {
                parts.push(<span key={`text-${key++}`}>{text.substring(lastIndex)}</span>);
            }
            
            return parts.length > 0 ? parts : <span>{text}</span>;
        }

        // ============================================================================
        // MANUAL API URL CONFIGURATION
        // ============================================================================
        // If auto-detection fails, uncomment and set your Codespace URL here:
        // const MANUAL_API_URL = 'https://YOUR-CODESPACE-5000.app.github.dev/api';
        const MANUAL_API_URL = 'https://automatic-winner-5gp6gg77j9gwc47qx-5000.app.github.dev/api';  // Leave as null to use auto-detection 
                
        // Auto-detect API URL with improved Codespace support
        function getApiUrl() {
            // Use manual override if provided
            if (MANUAL_API_URL) {
                console.log('üîß Using MANUAL API URL (configured in code)');
                console.log('üìç API URL:', MANUAL_API_URL);
                return MANUAL_API_URL;
            }
            
            const hostname = window.location.hostname;
            const port = window.location.port;
            const href = window.location.href;
            
            console.log('üîç Auto-detecting API URL...');
            console.log('   Full URL:', href);
            console.log('   Hostname:', hostname);
            console.log('   Port:', port || '(none)');
            
            // Check if we're in Codespaces (multiple possible patterns)
            const isCodespace = hostname.includes('.github.dev') || 
                               hostname.includes('.app.github.dev') ||
                               hostname.includes('.githubpreview.dev') ||
                               hostname.includes('github.dev');
            
            console.log('   Is Codespace?', isCodespace);
            
            if (isCodespace) {
                // Codespace URL pattern: NAME-PORT.app.github.dev
                // We need to replace the current port with 5000
                let apiUrl;
                
                if (port) {
                    // If there's a port in the URL, replace it
                    apiUrl = `https://${hostname.replace(/:\d+$/, '')}/api`.replace(/-\d+\./, '-5000.');
                } else {
                    // No port in hostname, replace the port number in the domain
                    apiUrl = `https://${hostname.replace(/-\d{4}\./, '-5000.')}/api`;
                }
                
                console.log('üåê Detected: Codespace environment');
                console.log('üìç API URL:', apiUrl);
                console.log('');
                console.log('‚ö†Ô∏è  If connection fails:');
                console.log('   1. Backend running: python3 api_auth.py');
                console.log('   2. Port 5000 is PUBLIC in PORTS tab');
                console.log('   3. Health check: ' + apiUrl.replace('/api', '/health'));
                console.log('   4. If still fails, use manual override (see line ~634)');
                
                return apiUrl;
            } else {
                // Local development
                const apiUrl = 'http://localhost:5000/api';
                console.log('üíª Detected: Local environment');
                console.log('üìç API URL:', apiUrl);
                console.log('');
                console.log('‚ö†Ô∏è  If you\'re in Codespaces but it detected local:');
                console.log('   1. Use manual override at line ~634');
                console.log('   2. Set: const MANUAL_API_URL = "https://YOUR-CODESPACE-5000.app.github.dev/api";');
                console.log('   3. Get URL from PORTS tab (port 5000)');
                return apiUrl;
            }
        }

        const API_URL = getApiUrl();
        
        console.log('');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üç≥ SmartFridge API Configuration');
        console.log('Using:', API_URL);
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('');

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                checkSession();
            }, []);

            const checkSession = async () => {
                try {
                    const response = await fetch(`${API_URL}/auth/session`, {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    
                    if (data.authenticated) {
                        setUser(data);
                    }
                } catch (error) {
                    console.error('Session check failed:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogin = (userData) => {
                setUser(userData);
            };

            const handleLogout = async () => {
                try {
                    await fetch(`${API_URL}/auth/logout`, {
                        method: 'POST',
                        credentials: 'include'
                    });
                    setUser(null);
                } catch (error) {
                    console.error('Logout failed:', error);
                }
            };

            if (loading) {
                return <div className="empty-state">Loading...</div>;
            }

            if (!user) {
                return <AuthPage onLogin={handleLogin} />;
            }

            return <MainApp user={user} onLogout={handleLogout} />;
        }

        function AuthPage({ onLogin }) {
            const [activeTab, setActiveTab] = useState('login');
            const [formData, setFormData] = useState({
                username: '',
                password: '',
                confirmPassword: ''
            });
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');

                if (activeTab === 'register' && formData.password !== formData.confirmPassword) {
                    setError('Passwords do not match');
                    return;
                }

                const endpoint = activeTab === 'login' ? '/auth/login' : '/auth/register';
                
                try {
                    const response = await fetch(`${API_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            username: formData.username,
                            password: formData.password
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        setSuccess(data.message);
                        onLogin({
                            authenticated: true,
                            user_id: data.user?.user_id || data.user_id,
                            username: data.user?.username || data.username
                        });
                    } else {
                        setError(data.message || 'Authentication failed');
                    }
                } catch (error) {
                    setError('Network error. Please try again.');
                }
            };

            return (
                <div className="auth-container">
                    <div className="auth-header">
                        <h1 style={{fontSize: '2rem', marginBottom: '0.5rem'}}>üç≥ SmartFridge</h1>
                        <p style={{color: '#8FA68E'}}>Your Personal Recipe Assistant</p>
                    </div>

                    <div className="auth-tabs">
                        <button 
                            className={`auth-tab ${activeTab === 'login' ? 'active' : ''}`}
                            onClick={() => setActiveTab('login')}
                        >
                            Login
                        </button>
                        <button 
                            className={`auth-tab ${activeTab === 'register' ? 'active' : ''}`}
                            onClick={() => setActiveTab('register')}
                        >
                            Register
                        </button>
                    </div>

                    {error && <div className="error-message">{error}</div>}
                    {success && <div className="success-message">{success}</div>}

                    <form onSubmit={handleSubmit}>
                        <div className="form-group">
                            <label>Username</label>
                            <input
                                type="text"
                                value={formData.username}
                                onChange={(e) => setFormData({...formData, username: e.target.value})}
                                required
                                minLength="3"
                            />
                        </div>

                        <div className="form-group">
                            <label>Password</label>
                            <input
                                type="password"
                                value={formData.password}
                                onChange={(e) => setFormData({...formData, password: e.target.value})}
                                required
                                minLength="6"
                            />
                        </div>

                        {activeTab === 'register' && (
                            <div className="form-group">
                                <label>Confirm Password</label>
                                <input
                                    type="password"
                                    value={formData.confirmPassword}
                                    onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})}
                                    required
                                />
                            </div>
                        )}

                        <button type="submit" className="btn btn-primary">
                            {activeTab === 'login' ? 'Login' : 'Create Account'}
                        </button>
                    </form>
                </div>
            );
        }

        function MainApp({ user, onLogout }) {
            const [showProfile, setShowProfile] = useState(false);
            const [cookingTerms, setCookingTerms] = useState({});

            useEffect(() => {
                loadCookingTerms();
            }, []);

            const loadCookingTerms = async () => {
                try {
                    const response = await fetch(`${API_URL}/cooking-terms`);
                    const data = await response.json();
                    setCookingTerms(data.terms || {});
                    console.log(`üìö Loaded ${Object.keys(data.terms || {}).length} cooking terms`);
                } catch (error) {
                    console.error('Failed to load cooking terms:', error);
                }
            };

            return (
                <>
                    <div className="app-header">
                        <div>
                            <h1 style={{fontSize: '2rem', marginBottom: '0', textAlign: 'left'}}>üç≥ SmartFridge</h1>
                        </div>
                        <div className="user-info">
                            <div className="user-avatar">
                                {user.username.charAt(0).toUpperCase()}
                            </div>
                            <span>Welcome, {user.username}!</span>
                            <div className="header-actions">
                                <button className="btn btn-secondary btn-small" onClick={() => setShowProfile(true)}>
                                    Profile
                                </button>
                                <button className="btn btn-primary btn-small" onClick={onLogout}>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>

                    <SmartFridgeApp cookingTerms={cookingTerms} />

                    {showProfile && <ProfileModal onClose={() => setShowProfile(false)} user={user} />}
                </>
            );
        }

        function ProfileModal({ onClose, user }) {
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [editing, setEditing] = useState(false);
            const [message, setMessage] = useState('');
            const [newIngredient, setNewIngredient] = useState('');

            useEffect(() => {
                loadProfile();
            }, []);

            const loadProfile = async () => {
                try {
                    const response = await fetch(`${API_URL}/profile`, {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    setProfile(data);
                } catch (error) {
                    console.error('Failed to load profile:', error);
                } finally {
                    setLoading(false);
                }
            };

            const addIngredientToProfile = async () => {
                if (!newIngredient.trim()) return;
                
                try {
                    const response = await fetch(`${API_URL}/ingredients`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ ingredient_name: newIngredient.trim() })
                    });
                    
                    if (response.ok) {
                        setNewIngredient('');
                        setMessage('Ingredient added!');
                        loadProfile();
                        setTimeout(() => setMessage(''), 2000);
                    }
                } catch (error) {
                    console.error('Failed to add ingredient:', error);
                }
            };

            const removeIngredientFromProfile = async (ingredientId) => {
                try {
                    const response = await fetch(`${API_URL}/ingredients/${ingredientId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        setMessage('Ingredient removed!');
                        loadProfile();
                        setTimeout(() => setMessage(''), 2000);
                    }
                } catch (error) {
                    console.error('Failed to remove ingredient:', error);
                }
            };

            const removeFavoriteFromProfile = async (recipeId) => {
                try {
                    const response = await fetch(`${API_URL}/favorites/${recipeId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        setMessage('Favorite removed!');
                        loadProfile();
                        setTimeout(() => setMessage(''), 2000);
                    }
                } catch (error) {
                    console.error('Failed to remove favorite:', error);
                }
            };

            const updateDietaryRestrictions = async (restrictions) => {
                try {
                    const response = await fetch(`${API_URL}/profile/dietary-restrictions`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ dietary_restrictions: restrictions })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setMessage('Dietary restrictions updated!');
                        loadProfile();
                        setTimeout(() => setMessage(''), 2000);
                    }
                } catch (error) {
                    console.error('Failed to update:', error);
                }
            };

            const updateSkillLevel = async (level) => {
                try {
                    const response = await fetch(`${API_URL}/profile/skill-level`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ skill_level: level })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setMessage('Skill level updated!');
                        loadProfile();
                        setTimeout(() => setMessage(''), 2000);
                    }
                } catch (error) {
                    console.error('Failed to update:', error);
                }
            };

            if (loading) {
                return (
                    <div className="modal-overlay">
                        <div className="modal-content">Loading profile...</div>
                    </div>
                );
            }

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Your Profile</h2>
                            <button className="close-btn" onClick={onClose}>√ó</button>
                        </div>

                        {message && <div className="success-message">{message}</div>}

                        <div className="profile-section">
                            <h3>Account Information</h3>
                            <p><strong>Username:</strong> {profile?.profile?.username}</p>
                            <p><strong>Skill Level:</strong> {profile?.profile?.skill_level}</p>
                        </div>

                        <div className="profile-section">
                            <h3>Dietary Restrictions</h3>
                            <div className="checkbox-group">
                                {['vegetarian', 'vegan', 'gluten-free', 'dairy-free', 'nut-free'].map(diet => (
                                    <label key={diet} className="checkbox-label">
                                        <input
                                            type="checkbox"
                                            checked={profile?.profile?.dietary_restrictions?.includes(diet) || false}
                                            onChange={(e) => {
                                                const current = profile?.profile?.dietary_restrictions || [];
                                                const updated = e.target.checked
                                                    ? [...current, diet]
                                                    : current.filter(d => d !== diet);
                                                updateDietaryRestrictions(updated);
                                            }}
                                        />
                                        <span>{diet}</span>
                                    </label>
                                ))}
                            </div>
                        </div>

                        <div className="profile-section">
                            <h3>Cooking Skill Level</h3>
                            <select
                                value={profile?.profile?.skill_level || 'beginner'}
                                onChange={(e) => updateSkillLevel(e.target.value)}
                                style={{width: '100%', padding: '0.75rem', borderRadius: '8px', border: '2px solid #E5D5C5'}}
                            >
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>

                        <div className="profile-section">
                            <h3>Your Pantry ({profile?.pantry?.length || 0} ingredients)</h3>
                            
                            {/* Add ingredient form */}
                            <div style={{marginBottom: '1rem'}}>
                                <div style={{display: 'flex', gap: '0.5rem'}}>
                                    <input
                                        type="text"
                                        placeholder="Add ingredient..."
                                        value={newIngredient}
                                        onChange={(e) => setNewIngredient(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && addIngredientToProfile()}
                                        style={{
                                            flex: 1,
                                            padding: '0.5rem',
                                            border: '2px solid #E5D5C5',
                                            borderRadius: '8px'
                                        }}
                                    />
                                    <button
                                        onClick={addIngredientToProfile}
                                        className="btn btn-secondary btn-small"
                                    >
                                        Add
                                    </button>
                                </div>
                            </div>

                            {profile?.pantry && profile.pantry.length > 0 ? (
                                <div className="ingredients-list" style={{marginTop: '1rem'}}>
                                    {profile.pantry.map((ing) => (
                                        <div key={ing.ingredient_id} className="ingredient-chip">
                                            {ing.name}
                                            {ing.amount && ing.amount !== 1 && ` (${ing.amount})`}
                                            {ing.exp_date && ` - exp ${new Date(ing.exp_date).toLocaleDateString()}`}
                                            <button
                                                className="remove-ingredient"
                                                onClick={() => removeIngredientFromProfile(ing.ingredient_id)}
                                                title="Remove ingredient"
                                            >
                                                √ó
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p style={{color: '#999', fontStyle: 'italic'}}>No ingredients yet. Add some above!</p>
                            )}
                        </div>

                        <div className="profile-section">
                            <h3>Favorite Recipes ({profile?.favorites?.length || 0})</h3>
                            {profile?.favorites && profile.favorites.length > 0 ? (
                                <div style={{marginTop: '1rem'}}>
                                    {profile.favorites.map((fav) => (
                                        <div key={fav.id} style={{
                                            padding: '0.75rem',
                                            background: '#F5EDE4',
                                            borderRadius: '8px',
                                            marginBottom: '0.5rem',
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center'
                                        }}>
                                            <div style={{flex: 1}}>
                                                <strong style={{color: '#D97642'}}>{fav.name}</strong>
                                                <div style={{fontSize: '0.9rem', color: '#666', marginTop: '0.25rem'}}>
                                                    {fav.match_percentage}% match
                                                    {fav.matched_ingredients && fav.matched_ingredients.length > 0 && (
                                                        <span> ‚Ä¢ ‚úÖ {fav.matched_ingredients.slice(0, 3).join(', ')}
                                                        {fav.matched_ingredients.length > 3 && '...'}</span>
                                                    )}
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => removeFavoriteFromProfile(fav.id)}
                                                style={{
                                                    background: '#E5D5C5',
                                                    border: 'none',
                                                    borderRadius: '4px',
                                                    padding: '0.5rem',
                                                    cursor: 'pointer',
                                                    marginLeft: '0.5rem',
                                                    color: '#666',
                                                    fontSize: '0.9rem'
                                                }}
                                                title="Remove from favorites"
                                            >
                                                Remove
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p style={{color: '#999', fontStyle: 'italic'}}>No favorites yet. Click ‚òÖ on recipes to save them!</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Rest of SmartFridgeApp component remains the same but with updated API calls...
        function SmartFridgeApp({ cookingTerms }) {
            const [pantryIngredients, setPantryIngredients] = useState([]);  // User's actual pantry
            const [searchIngredients, setSearchIngredients] = useState([]);  // Temporary search mode
            const [currentIngredient, setCurrentIngredient] = useState('');
            const [recipes, setRecipes] = useState([]);
            const [filteredRecipes, setFilteredRecipes] = useState([]);  // Recipes filtered by dietary restrictions
            const [filters, setFilters] = useState({
                maxTime: '',
                skillLevel: '',
                dietaryTags: [],
                cuisine: ''
            });
            const [cookingMode, setCookingMode] = useState(null);
            const [favorites, setFavorites] = useState(new Set());
            const [searchMode, setSearchMode] = useState('pantry');  // 'pantry' or 'search'
            const [userDietaryRestrictions, setUserDietaryRestrictions] = useState([]);  // User's dietary restrictions
            const [quickPick, setQuickPick] = useState(null);  // "Just Tell Me What To Cook" recommendation
            const [substitutions, setSubstitutions] = useState({});  // Ingredient substitutions cache

            useEffect(() => {
                loadUserData();
            }, []);

            useEffect(() => {
                // Auto-search when pantry loads or changes in pantry mode
                if (searchMode === 'pantry' && pantryIngredients.length > 0) {
                    performSearch(pantryIngredients);
                }
            }, [pantryIngredients, searchMode]);

            const loadUserData = async () => {
                try {
                    // Load pantry
                    const response = await fetch(`${API_URL}/ingredients`, {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    const ingredientNames = data.ingredients.map(ing => ({
                        id: ing.ingredient_id,
                        name: ing.name
                    }));
                    setPantryIngredients(ingredientNames);

                    // Load favorites
                    const favResponse = await fetch(`${API_URL}/favorites`, {
                        credentials: 'include'
                    });
                    const favData = await favResponse.json();
                    setFavorites(new Set(favData.favorites.map(fav => fav.id.toString())));
                    
                    // Load profile to get dietary restrictions
                    const profileResponse = await fetch(`${API_URL}/profile`, {
                        credentials: 'include'
                    });
                    const profileData = await profileResponse.json();
                    console.log('üìã Profile data received:', profileData);
                    
                    const restrictions = profileData?.profile?.dietary_restrictions || [];
                    // Filter out empty strings
                    const validRestrictions = restrictions.filter(r => r && r.trim().length > 0);
                    
                    console.log('üçΩÔ∏è Dietary restrictions loaded:', validRestrictions);
                    
                    // Store dietary restrictions for display
                    setUserDietaryRestrictions(validRestrictions);
                } catch (error) {
                    console.error('Failed to load user data:', error);
                }
            };

            const addSearchIngredient = () => {
                if (currentIngredient.trim() && !searchIngredients.find(ing => ing.name === currentIngredient.trim().toLowerCase())) {
                    setSearchIngredients([...searchIngredients, { 
                        id: 'temp-' + Date.now(), 
                        name: currentIngredient.trim().toLowerCase() 
                    }]);
                    setCurrentIngredient('');
                }
            };

            const removeSearchIngredient = (id) => {
                setSearchIngredients(searchIngredients.filter(ing => ing.id !== id));
            };

            const addToPantry = async () => {
                if (currentIngredient.trim()) {
                    try {
                        const response = await fetch(`${API_URL}/ingredients`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ ingredient_name: currentIngredient.trim() })
                        });
                        
                        if (response.ok) {
                            setCurrentIngredient('');
                            await loadUserData();  // Reload pantry
                        }
                    } catch (error) {
                        console.error('Failed to add ingredient:', error);
                    }
                }
            };

            const removeFromPantry = async (id) => {
                try {
                    const response = await fetch(`${API_URL}/ingredients/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        await loadUserData();  // Reload pantry
                    }
                } catch (error) {
                    console.error('Failed to remove ingredient:', error);
                }
            };

            const performSearch = async (ingredientsList) => {
                const searchFilters = {};
                if (filters.maxTime) searchFilters.max_time = parseInt(filters.maxTime);
                if (filters.skillLevel) searchFilters.skill_level = filters.skillLevel;
                if (filters.dietaryTags.length > 0) searchFilters.dietary_tags = filters.dietaryTags;
                if (filters.cuisine) searchFilters.cuisine = filters.cuisine;

                const ingredientNames = ingredientsList.map(ing => ing.name);

                try {
                    const response = await fetch(`${API_URL}/recipes/search`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            ingredient_names: ingredientNames,
                            filters: searchFilters
                        })
                    });

                    const data = await response.json();
                    setRecipes(data.results || []);
                    setFilteredRecipes(data.filtered_recipes || []);
                    
                    // Load substitutions for filtered recipes
                    if (data.filtered_recipes && data.filtered_recipes.length > 0) {
                        await loadSubstitutions(data.filtered_recipes, data.dietary_restrictions || []);
                    }
                } catch (error) {
                    console.error('Search failed:', error);
                }
            };

            const loadSubstitutions = async (filteredRecipes, dietaryRestrictions) => {
                // Collect all violating ingredients
                const violatingIngredients = new Set();
                filteredRecipes.forEach(recipe => {
                    if (recipe.violations) {
                        recipe.violations.forEach(v => {
                            violatingIngredients.add(v.ingredient);
                        });
                    }
                });

                if (violatingIngredients.size === 0) return;

                try {
                    const response = await fetch(`${API_URL}/substitutions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            ingredients: Array.from(violatingIngredients),
                            dietary_restrictions: dietaryRestrictions
                        })
                    });

                    const data = await response.json();
                    setSubstitutions(data.substitutions || {});
                    console.log(`üìù Loaded substitutions for ${Object.keys(data.substitutions || {}).length} ingredients`);
                } catch (error) {
                    console.error('Failed to load substitutions:', error);
                }
            };

            const handleManualSearch = () => {
                if (searchMode === 'search') {
                    performSearch(searchIngredients);
                } else {
                    performSearch(pantryIngredients);
                }
            };

            const toggleFavorite = async (recipeId, recipeName) => {
                const isFavorited = favorites.has(recipeId.toString());
                
                try {
                    if (isFavorited) {
                        await fetch(`${API_URL}/favorites/${recipeId}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });
                        setFavorites(prev => {
                            const newSet = new Set(prev);
                            newSet.delete(recipeId.toString());
                            return newSet;
                        });
                    } else {
                        await fetch(`${API_URL}/favorites`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ recipe_id: recipeId, recipe_name: recipeName })
                        });
                        setFavorites(prev => new Set([...prev, recipeId.toString()]));
                    }
                } catch (error) {
                    console.error('Failed to toggle favorite:', error);
                }
            };

            const startCooking = async (recipeId) => {
                try {
                    const response = await fetch(`${API_URL}/recipes/${recipeId}`, {
                        credentials: 'include'
                    });
                    const recipe = await response.json();
                    setCookingMode({ recipe, currentStep: 0 });
                } catch (error) {
                    console.error('Failed to load recipe:', error);
                }
            };

            const switchToSearchMode = () => {
                setSearchMode('search');
                setSearchIngredients([]);
                setRecipes([]);
                setQuickPick(null);  // Clear quick pick when switching modes
            };

            const switchToPantryMode = () => {
                setSearchMode('pantry');
                setSearchIngredients([]);
                setQuickPick(null);  // Clear quick pick when switching modes
                if (pantryIngredients.length > 0) {
                    performSearch(pantryIngredients);
                }
            };

            const getQuickPick = () => {
                // Filter for 100% matches only
                const perfectMatches = recipes.filter(r => r.match_percentage === 100);
                
                if (perfectMatches.length === 0) {
                    setQuickPick({ error: 'no_perfect_match', count: recipes.length });
                    return;
                }
                
                // Randomly pick one from perfect matches
                const randomIndex = Math.floor(Math.random() * perfectMatches.length);
                const selected = perfectMatches[randomIndex];
                
                setQuickPick({
                    recipe: selected,
                    totalPerfectMatches: perfectMatches.length
                });
            };

            const clearQuickPick = () => {
                setQuickPick(null);
            };

            if (cookingMode) {
                return <CookingMode mode={cookingMode} setMode={setCookingMode} cookingTerms={cookingTerms} />;
            }

            const currentIngredients = searchMode === 'pantry' ? pantryIngredients : searchIngredients;

            return (
                <div>
                    <p className="tagline">Find delicious recipes based on what you have! üéâ</p>

                    {/* Mode Switcher */}
                    <div className="section" style={{padding: '1rem 2rem'}}>
                        <div style={{display: 'flex', gap: '1rem', alignItems: 'center'}}>
                            <button
                                className={searchMode === 'pantry' ? 'btn btn-primary' : 'btn btn-secondary'}
                                onClick={switchToPantryMode}
                                style={{flex: 1}}
                            >
                                üè† My Pantry ({pantryIngredients.length} ingredients)
                            </button>
                            <button
                                className={searchMode === 'search' ? 'btn btn-primary' : 'btn btn-secondary'}
                                onClick={switchToSearchMode}
                                style={{flex: 1}}
                            >
                                üõí Shopping Mode (Try ingredients)
                            </button>
                        </div>
                        <p style={{marginTop: '0.5rem', fontSize: '0.9rem', color: '#666', textAlign: 'center'}}>
                            {searchMode === 'pantry' 
                                ? '‚ú® Showing recipes from your saved pantry ingredients' 
                                : 'üîç Search with temporary ingredients to see what you could make'}
                        </p>
                        
                        {/* Dietary Restrictions Indicator */}
                        {userDietaryRestrictions.length > 0 && (
                            <div style={{
                                marginTop: '1rem',
                                padding: '0.75rem',
                                background: 'linear-gradient(135deg, #FFF5E6, #FFE8CC)',
                                border: '2px solid #D97642',
                                borderRadius: '8px',
                                textAlign: 'center'
                            }}>
                                <div style={{fontSize: '0.9rem', fontWeight: '600', color: '#D97642', marginBottom: '0.5rem'}}>
                                    üçΩÔ∏è Active Dietary Restrictions
                                </div>
                                <div style={{display: 'flex', gap: '0.5rem', justifyContent: 'center', flexWrap: 'wrap'}}>
                                    {userDietaryRestrictions.map((restriction, idx) => (
                                        <span key={idx} style={{
                                            padding: '0.25rem 0.75rem',
                                            background: '#D97642',
                                            color: 'white',
                                            borderRadius: '12px',
                                            fontSize: '0.85rem',
                                            fontWeight: '600',
                                            textTransform: 'capitalize'
                                        }}>
                                            {restriction}
                                        </span>
                                    ))}
                                </div>
                                <div style={{fontSize: '0.8rem', color: '#666', marginTop: '0.5rem'}}>
                                    Recipes violating these restrictions are automatically hidden
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Quick Pick - "Just Tell Me What To Cook" */}
                    {searchMode === 'pantry' && pantryIngredients.length > 0 && (
                        <div className="section">
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                                <h2 style={{margin: 0}}>üé≤ Decision Helper</h2>
                                <button 
                                    className="btn btn-primary"
                                    onClick={getQuickPick}
                                    disabled={recipes.length === 0}
                                >
                                    üéØ Just Tell Me What To Cook!
                                </button>
                            </div>

                            {quickPick && (
                                quickPick.error ? (
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'linear-gradient(135deg, #FFF5E6, #FFE8CC)',
                                        border: '2px solid #D97642',
                                        borderRadius: '12px',
                                        textAlign: 'center'
                                    }}>
                                        <div style={{fontSize: '3rem', marginBottom: '0.5rem'}}>ü§î</div>
                                        <h3 style={{color: '#D97642', marginBottom: '0.5rem'}}>
                                            No Perfect Matches Yet
                                        </h3>
                                        <p style={{color: '#666', marginBottom: '0.5rem'}}>
                                            You're missing ingredients for all recipes. 
                                            {quickPick.count > 0 && ` Found ${quickPick.count} partial matches though!`}
                                        </p>
                                        <p style={{fontSize: '0.9rem', color: '#999'}}>
                                            Try adding more ingredients to your pantry, or check out the recipes below to see what you're missing.
                                        </p>
                                        <button 
                                            className="btn btn-secondary"
                                            onClick={clearQuickPick}
                                            style={{marginTop: '1rem'}}
                                        >
                                            Got it
                                        </button>
                                    </div>
                                ) : (
                                    <div style={{
                                        padding: '2rem',
                                        background: 'linear-gradient(135deg, #E8F5E9, #C8E6C9)',
                                        border: '3px solid #4CAF50',
                                        borderRadius: '12px',
                                        position: 'relative'
                                    }}>
                                        <button
                                            onClick={clearQuickPick}
                                            style={{
                                                position: 'absolute',
                                                top: '1rem',
                                                right: '1rem',
                                                background: 'rgba(255,255,255,0.9)',
                                                border: '2px solid #4CAF50',
                                                borderRadius: '50%',
                                                width: '32px',
                                                height: '32px',
                                                fontSize: '1.2rem',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                color: '#4CAF50'
                                            }}
                                        >
                                            √ó
                                        </button>
                                        
                                        <div style={{textAlign: 'center', marginBottom: '1.5rem'}}>
                                            <div style={{fontSize: '3rem', marginBottom: '0.5rem'}}>üéâ</div>
                                            <h2 style={{color: '#4CAF50', margin: '0 0 0.5rem 0', fontSize: '1.8rem'}}>
                                                You Can Cook This Now!
                                            </h2>
                                            <p style={{color: '#666', fontSize: '0.9rem'}}>
                                                {quickPick.totalPerfectMatches > 1 
                                                    ? `Randomly picked from ${quickPick.totalPerfectMatches} perfect matches` 
                                                    : 'Your only perfect match!'}
                                            </p>
                                        </div>

                                        <div style={{
                                            background: 'white',
                                            borderRadius: '8px',
                                            padding: '1.5rem',
                                            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                                        }}>
                                            <h3 style={{margin: '0 0 1rem 0', color: '#2C2416', fontSize: '1.5rem'}}>
                                                {quickPick.recipe.name}
                                            </h3>
                                            
                                            <div style={{
                                                display: 'flex',
                                                gap: '1rem',
                                                marginBottom: '1rem',
                                                flexWrap: 'wrap'
                                            }}>
                                                <div style={{
                                                    padding: '0.5rem 1rem',
                                                    background: '#4CAF50',
                                                    color: 'white',
                                                    borderRadius: '20px',
                                                    fontWeight: '600',
                                                    fontSize: '1.1rem'
                                                }}>
                                                    ‚úÖ 100% Match
                                                </div>
                                                <div style={{padding: '0.5rem 1rem', background: '#F5EDE4', borderRadius: '20px'}}>
                                                    ‚è±Ô∏è {quickPick.recipe.total_time} min
                                                </div>
                                                <div style={{padding: '0.5rem 1rem', background: '#F5EDE4', borderRadius: '20px'}}>
                                                    üë®‚Äçüç≥ {quickPick.recipe.skill_level}
                                                </div>
                                                <div style={{padding: '0.5rem 1rem', background: '#F5EDE4', borderRadius: '20px'}}>
                                                    üçΩÔ∏è {quickPick.recipe.servings} servings
                                                </div>
                                            </div>

                                            <div style={{marginBottom: '1rem'}}>
                                                <strong style={{color: '#4CAF50'}}>‚úÖ You have all ingredients:</strong>
                                                <div style={{marginTop: '0.5rem', color: '#666'}}>
                                                    {quickPick.recipe.matched_ingredients.join(', ')}
                                                </div>
                                            </div>

                                            <div style={{display: 'flex', gap: '1rem', marginTop: '1.5rem'}}>
                                                <button
                                                    className="btn btn-primary"
                                                    onClick={() => startCooking(quickPick.recipe.id)}
                                                    style={{flex: 1, fontSize: '1.1rem', padding: '0.75rem'}}
                                                >
                                                    üë®‚Äçüç≥ Let's Cook This!
                                                </button>
                                                <button
                                                    className={`btn-favorite ${favorites.has(quickPick.recipe.id.toString()) ? 'favorited' : ''}`}
                                                    onClick={() => toggleFavorite(quickPick.recipe.id, quickPick.recipe.name)}
                                                    style={{fontSize: '1.5rem', padding: '0.75rem 1.5rem'}}
                                                >
                                                    {favorites.has(quickPick.recipe.id.toString()) ? '‚òÖ' : '‚òÜ'}
                                                </button>
                                            </div>

                                            {quickPick.totalPerfectMatches > 1 && (
                                                <button
                                                    className="btn btn-secondary"
                                                    onClick={getQuickPick}
                                                    style={{width: '100%', marginTop: '1rem'}}
                                                >
                                                    üé≤ Pick Another Random Recipe
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                )
                            )}
                        </div>
                    )}

                    <div className="section">
                        <h2>{searchMode === 'pantry' ? 'Your Pantry' : 'Try These Ingredients'}</h2>
                        <div className="ingredient-input-container">
                            <input
                                type="text"
                                className="ingredient-input"
                                placeholder={searchMode === 'pantry' 
                                    ? "Add to your pantry (e.g., chicken, rice, tomato)..." 
                                    : "Add ingredient to try (e.g., chicken, rice, tomato)..."}
                                value={currentIngredient}
                                onChange={(e) => setCurrentIngredient(e.target.value)}
                                onKeyPress={(e) => {
                                    if (e.key === 'Enter') {
                                        searchMode === 'pantry' ? addToPantry() : addSearchIngredient();
                                    }
                                }}
                            />
                            <button 
                                className="add-btn" 
                                onClick={searchMode === 'pantry' ? addToPantry : addSearchIngredient}
                            >
                                {searchMode === 'pantry' ? '+ Add to Pantry' : '+ Add to Search'}
                            </button>
                        </div>
                        <div className="ingredients-list">
                            {currentIngredients.map((ingredient) => (
                                <div key={ingredient.id} className="ingredient-chip">
                                    {ingredient.name}
                                    <button
                                        className="remove-ingredient"
                                        onClick={() => searchMode === 'pantry' 
                                            ? removeFromPantry(ingredient.id) 
                                            : removeSearchIngredient(ingredient.id)}
                                    >
                                        √ó
                                    </button>
                                </div>
                            ))}
                        </div>
                        {searchMode === 'pantry' && pantryIngredients.length === 0 && (
                            <p style={{color: '#999', fontStyle: 'italic', marginTop: '1rem'}}>
                                Your pantry is empty. Add ingredients above, or add them from your Profile!
                            </p>
                        )}
                    </div>

                    <div className="section">
                        <h2>Filter Recipes</h2>
                        <div className="filters-grid">
                            <div className="filter-group">
                                <label>Max Cooking Time (minutes)</label>
                                <input
                                    type="number"
                                    value={filters.maxTime}
                                    onChange={(e) => setFilters({...filters, maxTime: e.target.value})}
                                    placeholder="e.g., 30"
                                />
                            </div>
                            <div className="filter-group">
                                <label>Skill Level</label>
                                <select
                                    value={filters.skillLevel}
                                    onChange={(e) => setFilters({...filters, skillLevel: e.target.value})}
                                >
                                    <option value="">All Levels</option>
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                            <div className="filter-group">
                                <label>Cuisine</label>
                                <input
                                    type="text"
                                    value={filters.cuisine}
                                    onChange={(e) => setFilters({...filters, cuisine: e.target.value})}
                                    placeholder="e.g., Italian"
                                />
                            </div>
                        </div>
                        <button className="btn btn-primary" onClick={handleManualSearch}>
                            üîç {searchMode === 'pantry' ? 'Refresh Results' : 'Search Recipes'}
                        </button>
                    </div>

                    <div className="section">
                        <h2>
                            {searchMode === 'pantry' ? 'Recipes You Can Make' : 'Recipes With These Ingredients'} 
                            ({recipes.length})
                        </h2>
                        {recipes.length === 0 ? (
                            <div className="empty-state">
                                <div className="empty-state-emoji">üîç</div>
                                <p>
                                    {searchMode === 'pantry' 
                                        ? 'Add ingredients to your pantry to find recipes!'
                                        : 'Add some ingredients and click Search to find recipes!'}
                                </p>
                            </div>
                        ) : (
                            <div className="recipes-grid">
                                {recipes.map((recipe) => (
                                    <div key={recipe.id} className="recipe-card">
                                        <div className="recipe-header">
                                            <h3 className="recipe-name">{recipe.name}</h3>
                                            <div className="match-percentage">{recipe.match_percentage}% Match</div>
                                            <div className="progress-bar">
                                                <div 
                                                    className="progress-fill"
                                                    style={{width: `${recipe.match_percentage}%`}}
                                                ></div>
                                            </div>
                                            <div className="recipe-details">
                                                ‚è±Ô∏è {recipe.total_time} min | 
                                                üë®‚Äçüç≥ {recipe.skill_level} | 
                                                üçΩÔ∏è {recipe.servings} servings
                                            </div>
                                            <div className="recipe-details">
                                                ‚úÖ Have: {recipe.matched_ingredients.join(', ')}
                                            </div>
                                            {recipe.missing_ingredients.length > 0 && (
                                                <div className="recipe-details">
                                                    ‚ùå Need: {recipe.missing_ingredients.join(', ')}
                                                </div>
                                            )}
                                            <div className="recipe-actions">
                                                <button 
                                                    className="btn-cook"
                                                    onClick={() => startCooking(recipe.id)}
                                                >
                                                    üë®‚Äçüç≥ Cook This Recipe
                                                </button>
                                                <button 
                                                    className={`btn-favorite ${favorites.has(recipe.id.toString()) ? 'favorited' : ''}`}
                                                    onClick={() => toggleFavorite(recipe.id, recipe.name)}
                                                >
                                                    {favorites.has(recipe.id.toString()) ? '‚òÖ' : '‚òÜ'}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Filtered Recipes - With Substitutions */}
                    {userDietaryRestrictions.length > 0 && filteredRecipes.length > 0 && (
                        <div className="section">
                            <h2 style={{color: '#D97642'}}>
                                üîÑ With Substitutions ({filteredRecipes.length})
                            </h2>
                            <p style={{color: '#666', marginBottom: '1.5rem'}}>
                                These recipes violate your dietary restrictions, but you could make them with ingredient substitutions:
                            </p>
                            
                            <div className="recipes-grid">
                                {filteredRecipes.map((recipe) => (
                                    <div key={recipe.id} className="recipe-card" style={{border: '2px solid #D97642', background: '#FFF5E6'}}>
                                        <div className="recipe-header">
                                            <h3 className="recipe-name">{recipe.name}</h3>
                                            <div className="match-percentage" style={{background: '#D97642'}}>{recipe.match_percentage}% Match</div>
                                            <div className="progress-bar">
                                                <div 
                                                    className="progress-fill"
                                                    style={{width: `${recipe.match_percentage}%`, background: '#D97642'}}
                                                ></div>
                                            </div>
                                            <div className="recipe-details">
                                                ‚è±Ô∏è {recipe.total_time} min | 
                                                üë®‚Äçüç≥ {recipe.skill_level} | 
                                                üçΩÔ∏è {recipe.servings} servings
                                            </div>
                                            
                                            {/* Violations and Substitutions */}
                                            {recipe.violations && recipe.violations.length > 0 && (
                                                <div style={{
                                                    marginTop: '1rem',
                                                    padding: '1rem',
                                                    background: 'white',
                                                    borderRadius: '8px',
                                                    border: '1px solid #E5D5C5'
                                                }}>
                                                    <div style={{fontWeight: '600', color: '#D97642', marginBottom: '0.75rem'}}>
                                                        ‚ö†Ô∏è Ingredients to Substitute:
                                                    </div>
                                                    
                                                    {recipe.violations.map((violation, idx) => {
                                                        const subs = substitutions[violation.ingredient] || [];
                                                        return (
                                                            <div key={idx} style={{marginBottom: '1rem'}}>
                                                                <div style={{fontWeight: '600', color: '#2C2416', marginBottom: '0.5rem'}}>
                                                                    ‚ùå {violation.ingredient} ({violation.restriction})
                                                                </div>
                                                                
                                                                {subs.length > 0 ? (
                                                                    <div style={{paddingLeft: '1.5rem'}}>
                                                                        {subs.map((sub, subIdx) => (
                                                                            <div key={subIdx} style={{
                                                                                marginBottom: '0.75rem',
                                                                                padding: '0.75rem',
                                                                                background: '#F5EDE4',
                                                                                borderRadius: '6px',
                                                                                fontSize: '0.9rem'
                                                                            }}>
                                                                                <div style={{fontWeight: '600', color: '#4CAF50', marginBottom: '0.25rem'}}>
                                                                                    ‚úì Try: {sub.name}
                                                                                </div>
                                                                                <div style={{fontSize: '0.85rem', color: '#666', marginBottom: '0.25rem'}}>
                                                                                    <strong>Ratio:</strong> {sub.ratio}
                                                                                </div>
                                                                                <div style={{fontSize: '0.85rem', color: '#666', marginBottom: '0.25rem'}}>
                                                                                    <strong>Impact:</strong> {sub.flavor_impact}
                                                                                </div>
                                                                                <div style={{fontSize: '0.85rem', color: '#666'}}>
                                                                                    <strong>Tip:</strong> {sub.cooking_notes}
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                ) : (
                                                                    <div style={{paddingLeft: '1.5rem', fontSize: '0.9rem', color: '#999', fontStyle: 'italic'}}>
                                                                        No substitutions available for this ingredient
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}

                                            <div className="recipe-details" style={{marginTop: '1rem'}}>
                                                ‚úÖ Have: {recipe.matched_ingredients.join(', ')}
                                            </div>
                                            {recipe.missing_ingredients.length > 0 && (
                                                <div className="recipe-details">
                                                    üõí Need: {recipe.missing_ingredients.join(', ')}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function CookingMode({ mode, setMode, cookingTerms }) {
            const { recipe, currentStep } = mode;
            const totalSteps = recipe.instructions.length;
            const step = recipe.instructions[currentStep];
            const progress = ((currentStep + 1) / totalSteps) * 100;
            
            // Cooking term popup state
            const [selectedTerm, setSelectedTerm] = useState(null);

            const nextStep = () => {
                if (currentStep < totalSteps - 1) {
                    setMode({ ...mode, currentStep: currentStep + 1 });
                    setSelectedTerm(null); // Close popup when changing steps
                }
            };

            const prevStep = () => {
                if (currentStep > 0) {
                    setMode({ ...mode, currentStep: currentStep - 1 });
                    setSelectedTerm(null); // Close popup when changing steps
                }
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };
            
            const handleTermClick = (term, definition) => {
                setSelectedTerm({ term, definition });
            };

            return (
                <div className="cooking-mode">
                    <div className="cooking-header">
                        <h2>{recipe.name}</h2>
                        <button className="exit-cooking" onClick={() => setMode(null)}>
                            ‚Üê Back to Recipes
                        </button>
                    </div>

                    <div className="progress-bar" style={{marginBottom: '2rem'}}>
                        <div className="progress-fill" style={{width: `${progress}%`}}></div>
                    </div>

                    {currentStep < totalSteps ? (
                        <div className="step-content">
                            <div className="step-number">
                                Step {currentStep + 1} of {totalSteps}
                            </div>
                            <div className="step-instruction">
                                {highlightCookingTerms(step.instruction, cookingTerms, handleTermClick)}
                            </div>
                            {step.time > 0 && (
                                <div className="step-timer">
                                    ‚è±Ô∏è Time: {formatTime(step.time)}
                                </div>
                            )}
                            {step.ingredients_needed && step.ingredients_needed.length > 0 && (
                                <div className="step-timer">
                                    ü•ò Ingredients: {step.ingredients_needed.join(', ')}
                                </div>
                            )}
                            
                            {/* Cooking tip about clickable terms */}
                            {cookingTerms && Object.keys(cookingTerms).length > 0 && (
                                <div style={{
                                    marginTop: '1rem',
                                    padding: '0.75rem',
                                    background: '#FFF5E6',
                                    borderRadius: '8px',
                                    fontSize: '0.9rem',
                                    color: '#666',
                                    textAlign: 'center'
                                }}>
                                    üí° <span style={{color: '#D97642', fontWeight: '600'}}>Underlined terms</span> are cooking terms - click them for definitions!
                                </div>
                            )}
                            
                            <div className="step-navigation">
                                <button
                                    className="nav-btn nav-btn-prev"
                                    onClick={prevStep}
                                    disabled={currentStep === 0}
                                >
                                    ‚Üê Previous
                                </button>
                                <button
                                    className="nav-btn nav-btn-next"
                                    onClick={nextStep}
                                >
                                    {currentStep === totalSteps - 1 ? 'Finish' : 'Next ‚Üí'}
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="step-content completion-screen">
                            <div className="completion-emoji">üéâ</div>
                            <h2>Congratulations!</h2>
                            <p>You've completed {recipe.name}!</p>
                            <button
                                className="nav-btn nav-btn-next"
                                onClick={() => setMode(null)}
                                style={{maxWidth: '300px', margin: '2rem auto'}}
                            >
                                Back to Recipes
                            </button>
                        </div>
                    )}
                    
                    {/* Cooking Term Popup */}
                    {selectedTerm && (
                        <CookingTermPopup
                            term={selectedTerm.term}
                            definition={selectedTerm.definition}
                            onClose={() => setSelectedTerm(null)}
                        />
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>